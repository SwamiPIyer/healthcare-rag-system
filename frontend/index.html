<!DOCTYPE html>
<html>
<head>
    <title>Healthcare RAG</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .upload-zone {
            border: 3px dashed #0d6efd;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-zone:hover {
            background-color: #f8f9fa;
            border-color: #0a58ca;
        }
        .upload-zone.dragover {
            background-color: #e7f1ff;
            border-color: #0a58ca;
        }
        .source-card {
            background-color: #f8f9fa;
            border-left: 4px solid #0d6efd;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1>üè• Healthcare RAG System</h1>
        <p class="text-muted">Upload PDFs, ask questions, get AI-powered answers</p>
        
        <!-- Data Source Selection -->
        <div class="card mt-4">
            <div class="card-header">
                <h5>Step 1: Choose Data Source</h5>
            </div>
            <div class="card-body">
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="source" id="source-sample" checked>
                    <label class="btn btn-outline-primary" for="source-sample" onclick="showSource('sample')">
                        üìÑ Sample Data
                    </label>
                    <input type="radio" class="btn-check" name="source" id="source-pdf">
                    <label class="btn btn-outline-success" for="source-pdf" onclick="showSource('pdf')">
                        üìé Upload PDF
                    </label>
                </div>
            </div>
        </div>

        <!-- Sample Data Section -->
        <div id="section-sample" class="card mt-3">
            <div class="card-body">
                <h6>üìÑ Sample Healthcare Articles</h6>
                <p>Load 3 pre-loaded medical articles for testing</p>
                <button class="btn btn-primary" onclick="loadData()">Load Sample Data</button>
            </div>
        </div>

        <!-- PDF Upload Section -->
        <div id="section-pdf" class="card mt-3" style="display:none;">
            <div class="card-body">
                <h6>üìé Upload Your PDF Document</h6>
                <div class="upload-zone" id="upload-zone" onclick="document.getElementById('pdf-input').click()">
                    <i style="font-size: 3rem; color: #0d6efd;">üìÑ</i>
                    <h5 class="mt-3">Click to Upload or Drag & Drop PDF</h5>
                    <p class="text-muted">Maximum file size: 50MB</p>
                    <input type="file" id="pdf-input" accept=".pdf" style="display:none;" onchange="handleFileSelect(event)">
                </div>
                <div id="pdf-info" class="alert alert-success mt-3" style="display:none;">
                    <strong>‚úì PDF Loaded:</strong> <span id="pdf-name"></span><br>
                    <small>Pages: <span id="pdf-pages"></span> | Size: <span id="pdf-size"></span> KB</small>
                </div>
            </div>
        </div>

        <!-- Build Index Section -->
        <div id="build-section" class="card mt-3" style="display:none;">
            <div class="card-header">
                <h5>Step 2: Build Index</h5>
            </div>
            <div class="card-body text-center">
                <button class="btn btn-success btn-lg" onclick="buildIndex()">
                    üî® Build Vector Index
                </button>
                <p class="text-muted mt-2">This will take 20-30 seconds</p>
            </div>
        </div>

        <!-- Query Section -->
        <div id="query-section" class="card mt-4" style="display:none;">
            <div class="card-header">
                <h5>Step 3: Ask Questions</h5>
            </div>
            <div class="card-body">
                <input type="text" id="query" class="form-control form-control-lg" placeholder="Ask a question about the documents...">
                <button class="btn btn-primary btn-lg mt-3" onclick="query()">üîç Submit Query</button>
                <div id="result" class="mt-4"></div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="status-messages" class="mt-3"></div>
    </div>

    <script>
        const API = "http://localhost:5001/api";
        let dataLoaded = false;
        let indexBuilt = false;

        // Show/hide sections based on data source
        function showSource(source) {
            document.getElementById('section-sample').style.display = source === 'sample' ? 'block' : 'none';
            document.getElementById('section-pdf').style.display = source === 'pdf' ? 'block' : 'none';
        }

        // Load sample data
        async function loadData() {
            try {
                showStatus('Loading sample data...', 'info');
                const res = await fetch(API + "/data/sample", {method: "POST"});
                const data = await res.json();
                
                if (data.success) {
                    dataLoaded = true;
                    showStatus('‚úì ' + data.message, 'success');
                    document.getElementById('build-section').style.display = 'block';
                } else {
                    showStatus('‚úó Error: ' + data.error, 'danger');
                }
            } catch (error) {
                showStatus('‚úó Error: ' + error.message, 'danger');
            }
        }

        // PDF Upload - Drag and Drop
        const uploadZone = document.getElementById('upload-zone');
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                uploadPDF(files[0]);
            }
        });

        // Handle file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                uploadPDF(file);
            }
        }

        // Upload PDF
        async function uploadPDF(file) {
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                showStatus('‚úó Please select a PDF file', 'danger');
                return;
            }

            try {
                showStatus('Uploading and processing PDF...', 'info');
                
                const formData = new FormData();
                formData.append('file', file);

                const res = await fetch(API + '/pdf/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await res.json();

                if (data.success) {
                    dataLoaded = true;
                    showStatus('‚úì ' + data.message, 'success');
                    
                    // Show PDF info
                    document.getElementById('pdf-name').textContent = data.pdf_info.filename;
                    document.getElementById('pdf-pages').textContent = data.pdf_info.num_pages;
                    document.getElementById('pdf-size').textContent = data.pdf_info.file_size_kb.toFixed(2);
                    document.getElementById('pdf-info').style.display = 'block';
                    
                    // Show build section
                    document.getElementById('build-section').style.display = 'block';
                } else {
                    showStatus('‚úó Error: ' + data.error, 'danger');
                }
            } catch (error) {
                showStatus('‚úó Error uploading PDF: ' + error.message, 'danger');
            }
        }

        // Build index
        async function buildIndex() {
            if (!dataLoaded) {
                showStatus('‚úó Please load data first', 'warning');
                return;
            }

            try {
                showStatus('Building vector index... This will take 20-30 seconds', 'info');
                
                const res = await fetch(API + "/index/build", {method: "POST"});
                const data = await res.json();
                
                if (data.success) {
                    indexBuilt = true;
                    showStatus('‚úì ' + data.message + ' - Ready for queries!', 'success');
                    document.getElementById('query-section').style.display = 'block';
                    document.getElementById('query-section').scrollIntoView({ behavior: 'smooth' });
                } else {
                    showStatus('‚úó Error: ' + data.error, 'danger');
                }
            } catch (error) {
                showStatus('‚úó Error: ' + error.message, 'danger');
            }
        }

        // Query system
        async function query() {
            if (!indexBuilt) {
                showStatus('‚úó Please build the index first', 'warning');
                return;
            }

            const q = document.getElementById("query").value.trim();
            if (!q) {
                showStatus('‚úó Please enter a question', 'warning');
                return;
            }

            try {
                showStatus('Searching and generating answer...', 'info');
                
                const res = await fetch(API + "/query", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({question: q})
                });
                
                const data = await res.json();
                
                if (data.success) {
                    displayAnswer(data.data);
                    showStatus('', ''); // Clear status
                } else {
                    showStatus('‚úó Error: ' + data.error, 'danger');
                }
            } catch (error) {
                showStatus('‚úó Error: ' + error.message, 'danger');
            }
        }

        // Display answer with sources
        function displayAnswer(result) {
            let html = '<div class="alert alert-success">';
            html += '<h5>üí¨ Answer:</h5>';
            html += '<p>' + result.answer + '</p>';
            html += '</div>';

            if (result.sources && result.sources.length > 0) {
                html += '<h6 class="mt-3">üìö Sources (' + result.num_sources + '):</h6>';
                result.sources.forEach((source, idx) => {
                    html += '<div class="source-card">';
                    html += '<strong>' + (idx + 1) + '. ' + source.title + '</strong><br>';
                    html += '<small class="text-muted">PMCID: ' + source.pmcid + ' | Relevance: ' + source.score.toFixed(3) + '</small><br>';
                    html += '<p class="mt-2 mb-0">' + source.text_snippet + '</p>';
                    html += '</div>';
                });
            }

            document.getElementById("result").innerHTML = html;
        }

        // Show status messages
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status-messages');
            if (!message) {
                statusDiv.innerHTML = '';
                return;
            }
            statusDiv.innerHTML = '<div class="alert alert-' + type + '">' + message + '</div>';
        }

        // Enter key support
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('query').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    query();
                }
            });
        });
    </script>
</body>
</html>
